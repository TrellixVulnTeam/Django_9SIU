# 보충 학습 (1:N)

## 시작하기

1. 바탕화면에서 Git Bash 열기

2. 프로젝트 클론 받기

    ```bash
    $ git clone https://lab.ssafy.com/s07/python/add-one-to-many.git
    ```

3. Visual Studio Code 열기

4. 가상환경 생성 및 실행

    ```bash
    $ python -m venv venv
    $ source venv/Scripts/activate

5. 패키지 설치

    ```bash
    (venv) $ pip install -r requirements.txt
    ```

6. 서버 실행 하기

## 가이드

시작하기 전에 회원가입/로그인 기능이 정상적으로 동작하는지 확인 해보세요.

### [필수] 사용자(1) : 게시글(N)

1. 모델 정의하기

   * [ForeignKey](https://docs.djangoproject.com/en/3.2/ref/models/fields/#django.db.models.ForeignKey)와 아래의 코드를 활용하여 Article 모델에 user 필드를 추가 해주세요.

     ```python
     from django.conf import settings
     user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
     ```

     ```python
     # 기존 코드
     class Article(models.Model):
         title = models.CharField(max_length=10)
         content = models.TextField()
         created_at = models.DateTimeField(auto_now_add=True)
         updated_at = models.DateTimeField(auto_now=True)
     
         def __str__(self):
             return self.title
     ```

   * 모델 정의가 완료되고 migration 파일을 생성하고, migrate 해주세요.

     ```bash
     $ python manage.py makemigration
     $ python manage.py migrate
     ```

2. 게시글 작성 구현하기(articles/views.py)

   * 게시글 작성할 때, 사용자 정보를 포함하여 저장할 수 있도록 기존 코드를 수정합니다.

   * 게시글 저장을 바로 하지 않고, [commit 옵션](https://docs.djangoproject.com/en/3.2/topics/forms/modelforms/#the-save-method)을 활용하여 로그인한 유저 정보를 추가한 후 저장해야 합니다.

     ```python
     # 기존 코드
     @login_required
     @require_http_methods(['GET', 'POST'])
     def create(request):
         if request.method == 'POST':
             form = ArticleForm(request.POST)
             if form.is_valid():
                 article = form.save()
                 return redirect('articles:detail', article.pk)
         else:
             form = ArticleForm()
         context = {
             'form': form,
         }
         return render(request, 'articles/create.html', context)
     ```

3. 작성자 정보 출력(articles/templates/articles/detail.html)

   * 아래의 코드를 활용하여 게시글 상세보기에서 user의 username을 출력하세요. 

     ```python
     article = Article.objects.get(pk=pk)
     article.user.username
     ```

     ```django
     <!-- 기존 코드 --> 
     {% extends 'base.html' %}
     
     {% block content %}
       <h1>DETAIL</h1>
       <h3>{{ article.pk }}번째 글</h3>
       <hr>
       <p>제목 : {{ article.title }}</p>
       <p>내용 : {{ article.content }}</p>
       <p>작성 시각 : {{ article.created_at }}</p>
       <p>수정 시각 : {{ article.updated_at }}</p>
       <hr>
       <a href="{% url 'articles:update' article.pk %}">수정</a>
       <form action="{% url 'articles:delete' article.pk %}" method="POST">
         {% csrf_token %}
         <input type="submit" value="삭제">
       </form>
       <a href="{% url 'articles:index' %}">back</a>
     {% endblock content %}
     ```

### [선택] 게시글(1) : 댓글(N), 사용자(1) : 댓글(N)

1. 모델 정의하기(articles/models.py)

   * 댓글은 게시글(article), 사용자(user), 내용(content), 작성시간(created_at)을 기록합니다.

     ```python
     class Comment(models.Model):
         article = models.ForeignKey(Article, on_delete=models.CASCADE)
         user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
         content = models.CharField(max_length=200)
         created_at = models.DateTimeField(auto_now_add=True)
         updated_at = models.DateTimeField(auto_now=True)
     ```

2. CommentForm 

   * 댓글을 입력 받을 수 있도록 form을 만듭니다. (articles/forms.py)

     ```python
     from .models import Comment
     
     class CommentForm(forms.ModelForm):
     
         class Meta:
             model = Comment
             fields = ('content',)
     ```

3. 댓글 Form 제공

   * 댓글은 게시글 상세보기 페이지에서 전달되어야 합니다.

   * articles/views.py의 `detail` 함수에서 CommentForm의 객체를 전달합니다.

   * 댓글 저장은 

     ```django
     <form action="{% url 'articles:comment_create' article.pk %}" method="POST">
         {% csrf_token %}
         {{ comment_form }}
         <input type="submit">
     </form>
     ```

4. 댓글 저장 로직 구현

   * URL 패턴은 아래와 같습니다.

       ```python
       path('<int:pk>/comments/', views.comment_create, name='comment_create'),
       ```

   * views.py에 `comment_create` 함수를 작성합니다. 
     * 작성 완료되면 해당 상세보기 페이지로 redirect 합니다.

5. 댓글 목록 출력(articles/views.py, articles/templates/articles/detail.html)

   * 댓글 목록을 출력하기 위해서 댓글 목록을 context로 전달하고, detail.html을 수정합니다.

     ```python
     comments = article.comment_set.all()
     ```

## 주의사항

* 모델을 변경하는 과정에서 `makemigration`을 할 때 기본 값에 대한 정보가 뜨게 됩니다.
* 편의상 옵션 `1`을 선택하고 `1`을 입력하고 엔터합니다.

![image-20220413153740094](README.assets/image-20220413153740094.png)
